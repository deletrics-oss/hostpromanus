<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBot Host v2.5 - Multi-Tenant</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: #fff; 
            min-height: 100vh; 
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Login Screen */
        .login-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }
        .login-card { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px); 
            border-radius: 20px; 
            padding: 50px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.2); 
            width: 100%; 
            max-width: 450px; 
        }
        .login-card h1 { 
            text-align: center; 
            margin-bottom: 10px; 
            font-size: 2.5rem; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        .login-card p { 
            text-align: center; 
            margin-bottom: 30px; 
            opacity: 0.9; 
            font-size: 1rem; 
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 10px; 
            background: rgba(255,255,255,0.95); 
            color: #333; 
            font-size: 1rem; 
        }
        .btn-primary, .btn-secondary { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 10px; 
            color: white; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: all 0.3s; 
            margin-top: 10px; 
            font-weight: 600; 
        }
        .btn-primary { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
        }
        .btn-secondary { 
            background: linear-gradient(45deg, #4CAF50, #45a049); 
        }
        .btn-primary:hover, .btn-secondary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); 
        }
        .error-message { 
            color: #ff6b6b; 
            text-align: center; 
            margin-top: 15px; 
            background: rgba(255, 107, 107, 0.1); 
            padding: 10px; 
            border-radius: 8px; 
        }
        .hidden { display: none !important; }
        
        /* Header */
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            padding: 20px 0; 
        }
        .header h1 { 
            font-size: 2.5rem; 
            margin-bottom: 10px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        .header p { 
            font-size: 1.1rem; 
            opacity: 0.9; 
        }
        
        /* Main Layout */
        .main-grid { 
            display: grid; 
            grid-template-columns: 300px 1fr; 
            gap: 30px; 
            min-height: calc(100vh - 200px); 
        }
        
        /* Sidebar */
        .sidebar { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }
        .card { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px); 
            border-radius: 15px; 
            padding: 25px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        .card h2 { 
            margin-bottom: 20px; 
            font-size: 1.3rem; 
            border-bottom: 2px solid rgba(255,255,255,0.3); 
            padding-bottom: 10px; 
        }
        .nav-menu button { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 10px; 
            border: none; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.1); 
            color: white; 
            font-size: 0.95rem; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .nav-menu button:hover, .nav-menu button.active { 
            background: rgba(255,255,255,0.2); 
            transform: translateX(5px); 
        }
        
        /* Status Grid */
        .status-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        }
        .status-item { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 12px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 10px; 
        }
        .status-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
        }
        .status-dot.green { 
            background: #4CAF50; 
            box-shadow: 0 0 10px #4CAF50; 
        }
        .status-dot.red { 
            background: #f44336; 
            box-shadow: 0 0 10px #f44336; 
        }
        .status-dot.yellow { 
            background: #ffeb3b; 
            box-shadow: 0 0 10px #ffeb3b; 
        }
        
        /* Device Management */
        .device-input { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .device-input input { 
            flex: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.9); 
            color: #333; 
        }
        .btn-add { 
            padding: 10px 20px; 
            background: linear-gradient(45deg, #4CAF50, #45a049); 
            border: none; 
            border-radius: 8px; 
            color: white; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.2s; 
        }
        .btn-add:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); 
        }
        .device-list { 
            list-style: none; 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .device-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            margin-bottom: 8px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 8px; 
            transition: all 0.2s; 
        }
        .device-list li:hover { 
            background: rgba(255,255,255,0.1); 
        }
        .device-list li.selected { 
            background: rgba(102, 126, 234, 0.2); 
            border-left: 4px solid #667eea; 
        }
        .device-info { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            cursor: pointer; 
            flex: 1; 
        }
        .device-actions { 
            display: flex; 
            gap: 5px; 
        }
        .btn-action { 
            padding: 5px 10px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            transition: all 0.2s; 
        }
        .btn-action:hover { 
            transform: scale(1.1); 
        }
        
        /* Content Area */
        .content-area { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        .content-area.full { 
            grid-template-columns: 1fr; 
        }
        
        /* QR Code Container */
        .qr-container { 
            text-align: center; 
            min-height: 300px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
        }
        .qr-container img { 
            max-width: 250px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
        }
        
        /* Gemini Logic */
        .gemini-section textarea { 
            width: 100%; 
            height: 150px; 
            padding: 10px; 
            border: none; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.9); 
            color: #333; 
            resize: vertical; 
            margin-bottom: 10px; 
        }
        .gemini-section input { 
            width: 100%; 
            padding: 10px; 
            border: none; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.9); 
            color: #333; 
            margin-bottom: 10px; 
        }
        .btn-generate { 
            width: 100%; 
            padding: 10px; 
            background: linear-gradient(45deg, #FF9800, #F57C00); 
            border: none; 
            border-radius: 8px; 
            color: white; 
            cursor: pointer; 
            font-weight: bold; 
            margin-bottom: 15px; 
            transition: all 0.2s; 
        }
        .btn-generate:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3); 
        }
        .logic-output { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 15px; 
        }
        .logic-output textarea { 
            height: 200px; 
        }
        
        /* Stripe Plans */
        .plans-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        .plan-card { 
            background: rgba(255,255,255,0.1); 
            border-radius: 15px; 
            padding: 25px; 
            text-align: center; 
            border: 2px solid rgba(255,255,255,0.2); 
            transition: all 0.3s; 
        }
        .plan-card:hover { 
            border-color: rgba(255,255,255,0.4); 
            transform: translateY(-5px); 
        }
        .plan-card h3 { 
            margin-bottom: 10px; 
            font-size: 1.5rem; 
        }
        .plan-card p { 
            margin-bottom: 15px; 
            opacity: 0.9; 
        }
        .plan-card.highlight { 
            border: 3px solid #4CAF50; 
            background: rgba(76, 175, 80, 0.1); 
        }
        .btn-subscribe { 
            width: 100%; 
            padding: 12px; 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            border: none; 
            border-radius: 8px; 
            color: white; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.2s; 
        }
        .btn-subscribe:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); 
        }
        
        /* Chat Area */
        .chat-section { 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
        }
        .conversation-list { 
            list-style: none; 
            max-height: 300px; 
            overflow-y: auto; 
            margin-bottom: 15px; 
        }
        .conversation-list li { 
            padding: 10px; 
            margin-bottom: 5px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .conversation-list li:hover { 
            background: rgba(255,255,255,0.1); 
        }
        .conversation-list li.selected { 
            background: rgba(102, 126, 234, 0.2); 
            border-left: 4px solid #667eea; 
        }
        .message-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            background: rgba(0,0,0,0.2); 
            border-radius: 10px; 
            margin-bottom: 15px; 
        }
        .message { 
            margin-bottom: 10px; 
            padding: 8px 12px; 
            border-radius: 10px; 
            max-width: 80%; 
        }
        .message.user { 
            background: rgba(33, 150, 243, 0.3); 
            margin-left: auto; 
        }
        .message.bot { 
            background: rgba(76, 175, 80, 0.3); 
        }
        .reply-container { 
            display: flex; 
            gap: 10px; 
        }
        .reply-container input { 
            flex: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.9); 
            color: #333; 
        }
        .btn-send { 
            padding: 10px 20px; 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            border: none; 
            border-radius: 8px; 
            color: white; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.2s; 
        }
        .btn-send:hover { 
            transform: translateY(-2px); 
        }
        
        /* Logs */
        .log-container { 
            height: 300px; 
            overflow-y: auto; 
            background: rgba(0,0,0,0.3); 
            border-radius: 10px; 
            padding: 15px; 
            font-family: monospace; 
            font-size: 0.9rem; 
        }
        .log-line { 
            margin-bottom: 5px; 
        }
        .log-line.ERROR { color: #ff6b6b; }
        .log-line.WARN { color: #ffd93d; }
        .log-line.INFO { color: #6bcf7f; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <div class="container">
            <div class="login-container">
                <div class="login-card">
                    <h1>ChatBot Host v2.5</h1>
                    <p>Sistema de Gerenciamento de Bots WhatsApp</p>
                    
                    <div id="login-form">
                        <div class="form-group">
                            <label>Usu√°rio</label>
                            <input type="text" id="login-username" placeholder="ex: email@dominio.com" value="admin">
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input type="password" id="login-password" placeholder="Sua senha" value="suporte@1">
                        </div>
                        <button id="loginBtn" class="btn-primary">Entrar</button>
                        <button id="showRegisterBtn" class="btn-secondary">Novo Cadastro</button>
                    </div>
                    
                    <div id="register-form" class="hidden">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="register-email" placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input type="password" id="register-password" placeholder="Crie uma senha">
                        </div>
                        <button id="registerBtn" class="btn-secondary">Cadastrar e Assinar</button>
                        <button id="showLoginBtn" class="btn-primary">Voltar para Login</button>
                    </div>
                    
                    <div id="login-error" class="error-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-app" class="hidden">
        <div class="container">
            <div class="header">
                <h1>ChatBot Host v2.5</h1>
                <p>Dashboard de Gerenciamento</p>
            </div>
            
            <div class="main-grid">
                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Navigation -->
                    <div class="card nav-menu">
                        <button id="nav-dashboard" class="active">Dashboard</button>
                        <button id="nav-gemini">Criador de L√≥gica IA</button>
                        <button id="nav-stripe">Assinatura (Stripe)</button>
                        <button id="logoutBtn">Sair</button>
                    </div>
                    
                    <!-- Status -->
                    <div class="card">
                        <h2>Status do Sistema</h2>
                        <div class="status-grid">
                            <div class="status-item">
                                <span id="status-gemini" class="status-dot red"></span>
                                <span>Gemini AI</span>
                            </div>
                            <div class="status-item">
                                <span id="status-websocket" class="status-dot red"></span>
                                <span>WebSocket</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Content Area -->
                <div class="content-area full" id="content-area">
                    <!-- Dashboard View -->
                    <div id="view-dashboard" class="card">
                        <h2>Dispositivos WhatsApp</h2>
                        
                        <div class="device-input">
                            <input type="text" id="new-device-name" placeholder="Nome do dispositivo (ex: vendas)">
                            <button class="btn-add" id="add-device-btn">Adicionar</button>
                        </div>
                        
                        <ul class="device-list" id="device-list"></ul>
                        
                        <div class="card" style="margin-top: 20px;">
                            <h2>Autentica√ß√£o WhatsApp</h2>
                            <div class="qr-container" id="qr-container">
                                <p>Selecione um dispositivo para ver o QR Code</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gemini Logic View -->
                    <div id="view-gemini" class="card hidden">
                        <h2>Criador de L√≥gica IA (Gemini)</h2>
                        <div class="gemini-section">
                            <label>Descri√ß√£o da L√≥gica</label>
                            <textarea id="gemini-description" placeholder="Descreva o comportamento desejado para o bot..."></textarea>
                            <button class="btn-generate" id="generate-logic-btn">Gerar L√≥gica</button>
                            
                            <div id="gemini-output" class="hidden">
                                <div class="logic-output">
                                    <div>
                                        <label>JSON (Fluxo)</label>
                                        <textarea id="gemini-json-output" readonly></textarea>
                                        <input type="text" id="json-filename" placeholder="Nome do arquivo (ex: flow.json)" value="flow.json">
                                        <button class="btn-generate" id="save-json-btn">Salvar JSON</button>
                                    </div>
                                    <div>
                                        <label>TXT (Base de Conhecimento)</label>
                                        <textarea id="gemini-txt-output" readonly></textarea>
                                        <input type="text" id="txt-filename" placeholder="Nome do arquivo (ex: knowledge.txt)" value="knowledge.txt">
                                        <button class="btn-generate" id="save-txt-btn">Salvar TXT</button>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 style="margin-top: 20px;">L√≥gicas Salvas</h3>
                            <ul class="device-list" id="logic-list"></ul>
                        </div>
                    </div>
                    
                    <!-- Stripe Plans View -->
                    <div id="view-stripe" class="card hidden">
                        <h2>Gerenciamento de Assinatura</h2>
                        <p style="margin-bottom: 20px;">Status da Assinatura: <span id="subscription-status" style="color: #ffeb3b;">Verificando...</span></p>
                        
                        <div class="plans-grid">
                            <div class="plan-card highlight">
                                <h3>Plano Free (30 Dias)</h3>
                                <p>Teste todas as funcionalidades por 30 dias. Inclui 1 dispositivo.</p>
                                <button class="btn-subscribe" data-price-id="price_free">Assinar Plano Free</button>
                            </div>
                            
                            <div class="plan-card">
                                <h3>Plano Bot Fixo</h3>
                                <p>Assinatura mensal com 1 bot fixo e l√≥gicas IA ilimitadas.</p>
                                <button class="btn-subscribe" data-price-id="price_fixed">Assinar Plano Bot Fixo</button>
                            </div>
                        </div>
                        
                        <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
                            *A chave p√∫blica do Stripe ser√° configurada no backend.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const API_URL = 'http://72.60.246.250:3035/api';
        const WS_URL = 'ws://72.60.246.250:3035';
        let stripe = null;
        let clientId = null;
        let selectedSessionId = null;
        let activeSessions = {};
        let ws = null;

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const deviceList = document.getElementById('device-list');
        const newDeviceNameInput = document.getElementById('new-device-name');
        const addDeviceBtn = document.getElementById('add-device-btn');
        const qrContainer = document.getElementById('qr-container');
        const statusGemini = document.getElementById('status-gemini');
        const statusWebsocket = document.getElementById('status-websocket');
        const contentArea = document.getElementById('content-area');
        const geminiDescription = document.getElementById('gemini-description');
        const generateLogicBtn = document.getElementById('generate-logic-btn');
        const geminiJsonOutput = document.getElementById('gemini-json-output');
        const geminiTxtOutput = document.getElementById('gemini-txt-output');
        const jsonFilename = document.getElementById('json-filename');
        const txtFilename = document.getElementById('txt-filename');
        const saveJsonBtn = document.getElementById('save-json-btn');
        const saveTxtBtn = document.getElementById('save-txt-btn');
        const geminiOutput = document.getElementById('gemini-output');
        const logicList = document.getElementById('logic-list');
        const subscriptionStatus = document.getElementById('subscription-status');
        const logoutBtn = document.getElementById('logoutBtn');

        // Navigation
        document.getElementById('nav-dashboard').addEventListener('click', () => showView('view-dashboard'));
        document.getElementById('nav-gemini').addEventListener('click', () => showView('view-gemini'));
        document.getElementById('nav-stripe').addEventListener('click', () => showView('view-stripe'));

        function showView(viewId) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-menu button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Authentication
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            clientId = localStorage.getItem('clientId');
            
            if (token && clientId) {
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                connectWebSocket();
                checkSystemHealth();
                loadDevices();
                fetchAndDisplayLogics();
                setInterval(checkSystemHealth, 30000);
            } else {
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        }

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                loginError.textContent = 'Usu√°rio e senha s√£o obrigat√≥rios.';
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('clientId', data.clientId);
                    clientId = data.clientId;
                    checkAuth();
                } else {
                    loginError.textContent = data.error || 'Falha no login.';
                }
            } catch (error) {
                loginError.textContent = 'Erro de conex√£o com o servidor.';
            }
        });

        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });

        document.getElementById('showLoginBtn').addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        document.getElementById('registerBtn').addEventListener('click', async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!email || !password) {
                loginError.textContent = 'Email e senha s√£o obrigat√≥rios.';
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('clientId', data.clientId);
                    clientId = data.clientId;
                    checkAuth();
                } else {
                    loginError.textContent = data.error || 'Falha no cadastro.';
                }
            } catch (error) {
                loginError.textContent = 'Erro de conex√£o com o servidor.';
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('clientId');
            clientId = null;
            if (ws) ws.close();
            checkAuth();
        });

        // WebSocket Connection
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    statusWebsocket.className = 'status-dot green';
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'qr_code') {
                        if (data.sessionId === selectedSessionId) {
                            qrContainer.innerHTML = `<img src="${data.qrCode}" alt="QR Code">`;
                        }
                    } else if (data.type === 'status_update') {
                        if (activeSessions[data.sessionId]) {
                            activeSessions[data.sessionId].status = data.status;
                            renderDeviceList();
                        }
                    }
                };
                
                ws.onclose = () => {
                    statusWebsocket.className = 'status-dot red';
                    setTimeout(connectWebSocket, 5000);
                };
            } catch (error) {
                statusWebsocket.className = 'status-dot red';
            }
        }

        function checkSystemHealth() {
            fetch(`${API_URL}/health/gemini`)
                .then(res => res.json())
                .then(data => {
                    statusGemini.className = `status-dot ${data.status === 'OPERATIONAL' ? 'green' : 'red'}`;
                })
                .catch(() => {
                    statusGemini.className = 'status-dot red';
                });
        }

        // Device Management
        function loadDevices() {
            fetch(`${API_URL}/sessions`, {
                headers: { 'X-Client-Id': clientId }
            })
            .then(res => res.json())
            .then(data => {
                activeSessions = {};
                data.forEach(session => {
                    activeSessions[session.id] = { status: session.status };
                });
                renderDeviceList();
            })
            .catch(error => console.error('Erro ao carregar dispositivos:', error));
        }

        function renderDeviceList() {
            deviceList.innerHTML = '';
            for (const sessionId in activeSessions) {
                const li = document.createElement('li');
                if (sessionId === selectedSessionId) li.classList.add('selected');
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'device-info';
                infoDiv.onclick = () => selectDevice(sessionId);
                
                const statusDot = document.createElement('span');
                statusDot.className = 'status-dot';
                const status = activeSessions[sessionId].status;
                if (status === 'READY') statusDot.classList.add('green');
                else if (status === 'QR_PENDING') statusDot.classList.add('yellow');
                else statusDot.classList.add('red');
                
                infoDiv.appendChild(statusDot);
                infoDiv.appendChild(document.createTextNode(sessionId));
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'device-actions';
                
                const restartBtn = document.createElement('button');
                restartBtn.className = 'btn-action';
                restartBtn.innerHTML = 'üîÑ';
                restartBtn.style.background = '#FF9800';
                restartBtn.style.color = 'white';
                restartBtn.onclick = (e) => {
                    e.stopPropagation();
                    restartDevice(sessionId);
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-action';
                deleteBtn.innerHTML = '‚úï';
                deleteBtn.style.background = '#f44336';
                deleteBtn.style.color = 'white';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteDevice(sessionId);
                };
                
                actionsDiv.appendChild(restartBtn);
                actionsDiv.appendChild(deleteBtn);
                
                li.appendChild(infoDiv);
                li.appendChild(actionsDiv);
                deviceList.appendChild(li);
            }
        }

        addDeviceBtn.addEventListener('click', async () => {
            const sessionId = newDeviceNameInput.value.trim();
            if (!sessionId || activeSessions[sessionId]) {
                alert('Nome inv√°lido ou dispositivo j√° existe.');
                return;
            }
            
            try {
                await fetch(`${API_URL}/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Client-Id': clientId },
                    body: JSON.stringify({ sessionId })
                });
                
                activeSessions[sessionId] = { status: 'INITIALIZING' };
                newDeviceNameInput.value = '';
                renderDeviceList();
                selectDevice(sessionId);
            } catch (error) {
                alert('Erro ao criar dispositivo.');
            }
        });

        function selectDevice(sessionId) {
            selectedSessionId = sessionId;
            renderDeviceList();
            qrContainer.innerHTML = '<p>Carregando QR Code...</p>';
        }

        async function deleteDevice(sessionId) {
            if (!confirm(`Remover "${sessionId}"?`)) return;
            
            try {
                await fetch(`${API_URL}/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: { 'X-Client-Id': clientId }
                });
                
                delete activeSessions[sessionId];
                if (selectedSessionId === sessionId) selectedSessionId = null;
                renderDeviceList();
            } catch (error) {
                alert('Erro ao remover dispositivo.');
            }
        }

        async function restartDevice(sessionId) {
            if (!confirm(`Reiniciar "${sessionId}"?`)) return;
            
            try {
                await fetch(`${API_URL}/sessions/${sessionId}/restart`, {
                    method: 'POST',
                    headers: { 'X-Client-Id': clientId }
                });
                selectDevice(sessionId);
            } catch (error) {
                alert('Erro ao reiniciar dispositivo.');
            }
        }

        // Gemini Logic
        generateLogicBtn.addEventListener('click', async () => {
            const description = geminiDescription.value.trim();
            if (!description) {
                alert('Por favor, insira uma descri√ß√£o.');
                return;
            }
            
            generateLogicBtn.textContent = 'Gerando...';
            generateLogicBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/logics/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Client-Id': clientId },
                    body: JSON.stringify({ description })
                });
                const data = await response.json();
                
                if (data.success) {
                    geminiJsonOutput.value = data.json;
                    geminiTxtOutput.value = data.txt;
                    geminiOutput.classList.remove('hidden');
                } else {
                    alert(data.error || 'Falha na gera√ß√£o.');
                }
            } catch (error) {
                alert('Erro ao gerar l√≥gica.');
            } finally {
                generateLogicBtn.textContent = 'Gerar L√≥gica';
                generateLogicBtn.disabled = false;
            }
        });

        saveJsonBtn.addEventListener('click', () => saveLogic(jsonFilename.value, geminiJsonOutput.value));
        saveTxtBtn.addEventListener('click', () => saveLogic(txtFilename.value, geminiTxtOutput.value));

        async function saveLogic(fileName, content) {
            if (!fileName || !content) return;
            
            try {
                await fetch(`${API_URL}/logics/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Client-Id': clientId },
                    body: JSON.stringify({ fileName, content })
                });
                alert('L√≥gica salva com sucesso!');
                fetchAndDisplayLogics();
            } catch (error) {
                alert('Erro ao salvar l√≥gica.');
            }
        }

        async function fetchAndDisplayLogics() {
            try {
                const response = await fetch(`${API_URL}/logics`, {
                    headers: { 'X-Client-Id': clientId }
                });
                const files = await response.json();
                
                logicList.innerHTML = '';
                files.forEach(fileName => {
                    const li = document.createElement('li');
                    li.textContent = fileName;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '‚úï';
                    deleteBtn.className = 'btn-action';
                    deleteBtn.style.background = '#f44336';
                    deleteBtn.style.color = 'white';
                    deleteBtn.onclick = () => deleteLogic(fileName);
                    
                    li.appendChild(deleteBtn);
                    logicList.appendChild(li);
                });
            } catch (error) {
                console.error('Erro ao carregar l√≥gicas:', error);
            }
        }

        async function deleteLogic(fileName) {
            if (!confirm(`Deletar "${fileName}"?`)) return;
            
            try {
                await fetch(`${API_URL}/logics/${fileName}`, {
                    method: 'DELETE',
                    headers: { 'X-Client-Id': clientId }
                });
                fetchAndDisplayLogics();
            } catch (error) {
                alert('Erro ao deletar l√≥gica.');
            }
        }

        // Stripe
        document.querySelectorAll('.btn-subscribe').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const priceId = e.target.dataset.priceId;
                
                try {
                    const response = await fetch(`${API_URL}/stripe/create-checkout-session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Client-Id': clientId },
                        body: JSON.stringify({ email: `${clientId}@example.com`, priceId, mode: 'subscription' })
                    });
                    const session = await response.json();
                    
                    if (session.id) {
                        if (!stripe) stripe = Stripe('pk_test_YOUR_KEY');
                        stripe.redirectToCheckout({ sessionId: session.id });
                    } else {
                        alert(session.error || 'Erro ao iniciar checkout.');
                    }
                } catch (error) {
                    alert('Erro ao conectar com Stripe.');
                }
            });
        });

        // Initialize
        checkAuth();
    </script>
</body>
</html>
